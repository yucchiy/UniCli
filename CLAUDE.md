# UniCli

## Project Structure

- `src`: Source code directory
    - `src/UniCli.Client`: CLI project for `unicli`
    - `src/UniCli.Unity`: Unity server implementation for `unicli` (Unity project)
        - `src/UniCli.Unity/Packages`: Server package
        - `src/UniCli.Unity/Assets/Samples`: Sample implementations for the server package
    - `src/UniCli.SourceGenerator`: Roslyn Source Generator for auto-generating Settings command handlers
- `src/UniCli.Protocol`: Shared type definitions between `UniCli.Client` and `UniCli.Unity`
- `doc`: Documentation directory

## Quick Commands

```bash
# Build Protocol (must be built first to trigger file copy)
dotnet build src/UniCli.Protocol

# Build Client
dotnet build src/UniCli.Client

# Publish Client and test with the built binary
dotnet publish src/UniCli.Client -o .build
UNICLI_PROJECT=src/UniCli.Unity .build/unicli commands --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Compile --json

# GameObject operations
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec GameObject.GetComponents '{"path":"Main Camera"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec GameObject.AddComponent '{"path":"Main Camera","typeName":"BoxCollider"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec GameObject.RemoveComponent '{"componentInstanceId":12345}' --json

# Prefab operations
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Prefab.GetStatus '{"path":"Main Camera"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Prefab.Instantiate '{"assetPath":"Assets/Prefabs/Enemy.prefab"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Prefab.Save '{"path":"Main Camera","assetPath":"Assets/TestPrefab.prefab"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Prefab.Apply '{"path":"MyPrefabInstance"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Prefab.Unpack '{"path":"MyPrefabInstance"}' --json

# Scene operations
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Scene.List --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Scene.GetActive --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Scene.Open '{"path":"Assets/Scenes/SampleScene.unity"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Scene.Open '{"path":"Assets/Scenes/Additive.unity","additive":true}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Scene.SetActive '{"name":"SampleScene"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Scene.Save '{"all":true}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Scene.Close '{"name":"Additive"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Scene.New '{"empty":true,"additive":true}' --json

# PackageManager operations
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec PackageManager.GetInfo '{"name":"com.unity.test-framework"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec PackageManager.Update '{"name":"com.unity.test-framework"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec PackageManager.Update '{"name":"com.unity.test-framework","version":"1.4.5"}' --json

# AssetDatabase operations
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec AssetDatabase.Delete '{"path":"Assets/Prefabs/Old.prefab"}' --json

# Run Unity EditMode tests
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec TestRunner.RunEditMode --json

# Run Unity PlayMode tests
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec TestRunner.RunPlayMode --json

# Build player
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Build --locationPathName "Builds/Test.app" --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Build --locationPathName "Builds/Test.app" --options Development --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Build --locationPathName "Builds/Test.app" --options Development --options ConnectWithProfiler --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Build --locationPathName "Builds/Test.app" --target Android --scenes "Assets/Scenes/SampleScene.unity" --json

# Compile player scripts for a specific build target
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec CompilePlayer --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec CompilePlayer --target Android --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec CompilePlayer --target iOS --extraScriptingDefines MY_DEFINE --extraScriptingDefines ANOTHER_DEFINE --json

# Settings operations (auto-generated by Source Generator)
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec PlayerSettings.Inspect --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec PlayerSettings.SetCompanyName '{"value":"MyCompany"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec PlayerSettings.Android.SetMinSdkVersion '{"value":"AndroidApiLevel28"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec PlayerSettings.SetScriptingBackend '{"buildTarget":"Android","value":"IL2CPP"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec EditorSettings.Inspect --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec EditorUserBuildSettings.Inspect --json

# TypeCache and type inspection
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec TypeCache.List '{"baseType":"UniCli.Server.Editor.Handlers.ICommandHandler"}' --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec TypeInspect '{"typeName":"UnityEditor.PlayerSettings"}' --json

# Compile Unity project (also serves as a build verification for the server)
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Compile --json
```

## Testing

When testing CLI behavior, always publish first with `dotnet publish src/UniCli.Client -o .build`, then test with `.build/unicli` directly. Do not use `dotnet run`.

### Server-side verification (required)

`dotnet build` only verifies the client-side compilation. When modifying server-side code (`Packages/com.yucchiy.unicli-server/`), **always verify with Unity compilation and tests**.

```bash
# 1. Build Source Generator (if modified)
dotnet build src/UniCli.SourceGenerator

# 2. Publish the client first
dotnet publish src/UniCli.Client -o .build

# 3. Verify server-side compilation (required)
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec Compile --json

# 3. Run tests
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec TestRunner.RunEditMode --json
UNICLI_PROJECT=src/UniCli.Unity .build/unicli exec TestRunner.RunPlayMode --json
```

### Maintaining documentation

When adding or modifying commands, update the following files to keep them in sync:

- `README.md` — Available Commands table and Examples section
- `.claude-plugin/unicli/skills/unicli/SKILL.md` — Built-in Commands table and Common Workflows section

### Releasing a new version

1. Create a `release/vX.Y.Z` branch from `main`
2. Bump version in the following 3 files:
   - `src/UniCli.Client/UniCli.Client.csproj` (`<Version>`)
   - `src/UniCli.Unity/Packages/com.yucchiy.unicli-server/package.json` (`"version"`)
   - `.claude-plugin/marketplace.json` (`"version"`)
3. Build and verify: `dotnet build src/UniCli.Protocol && dotnet publish src/UniCli.Client -o .build`
4. Create a PR to `main` with a changelog summary
5. After merge: `git tag vX.Y.Z && git push origin vX.Y.Z`
   - GitHub Actions (`.github/workflows/release.yml`) will automatically build binaries and create a GitHub Release

### Tests requiring Unity connection

The `exec` and `commands` subcommands require a connection to the Unity Editor. If the connection fails, retry a few times. If it still fails, ask the user to confirm that Unity Editor is running with the project open.
